var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(t,o,a)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[o]=a,s=(e,t)=>{for(var o in t||(t={}))l.call(t,o)&&n(e,o,t[o]);if(a)for(var o of a(t))r.call(t,o)&&n(e,o,t[o]);return e},c=(e,a)=>t(e,o(a));import{q as i,D as u,R as d,T as h,r as p,a as m,b as w,c as y,d as v,e as f}from"./vendor.effd306c.js";const g={setPath:(e,t)=>c(s({},e),{path:t}),setPlay:(e,t)=>c(s({},e),{play:t}),setShowPreviewCover:(e,t)=>c(s({},e),{showPreviewCover:t}),setColor:(e,t)=>c(s({},e),{color:t}),setBackgroundColor:(e,t)=>c(s({},e),{backgroundColor:t}),setWidth:(e,t)=>c(s({},e),{width:t}),setShowPwdDialog:(e,t)=>c(s({},e),{showPwdDialog:t}),setPreviewMode:(e,t)=>c(s({},e),{previewMode:t}),setPreview:(e,t)=>c(s({},e),{preview:t}),setSave:(e,t)=>c(s({},e),{isSave:t}),setCode:(e,t)=>c(s({},e),{code:t})},{code:E="秦丹",edit:C}=i(location.search);console.log("口令",E,C);const x={path:[],color:"#000000",backgroundColor:"#ffffff",width:4,play:!1,code:E,previewMode:!!E&&void 0===C,showPreviewCover:!1,showPwdDialog:!1,isSave:!1,preview:!1},P=(e,t)=>{var o;return null==(o=g[t.type])?void 0:o.call(g,e,t.payload)},b=u.exports.createContext({state:x});class k{constructor(e,t,o=6){this.ctx=e,this.defaultWidth=6,this.defaultColor="#000000",this.restarting=!0,this.isPlay=!1,this.isComplete=!1,this.setBackground(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.color=t||this.defaultColor,this.width=o}set color(e){this.ctx.strokeStyle=e||this.defaultColor}get color(){return this.ctx.strokeStyle}set width(e){this.ctx.lineWidth=e||this.defaultWidth}get width(){return this.ctx.lineWidth}get background(){return this.ctx.fillStyle}drawLine({x:e,y:t}){return this.restarting&&(this.restarting=!1,this.ctx.moveTo(e,t),this.ctx.beginPath()),this.ctx.lineTo(e,t),this.ctx.stroke(),this}end(){return this.restarting=!0,this.ctx.closePath(),this}setBackground(e){this.ctx.fillStyle=e||"#ffffff";const{width:t,height:o}=this.ctx.canvas;this.ctx.fillRect(-t/2,-o/2,t,o)}clear(){const{width:e,height:t}=this.ctx.canvas;this.ctx.clearRect(-e/2,-t/2,e,t)}drawPath(e){console.log("drawPath",e),e.length&&e.forEach((({pos:e,color:t,width:o})=>{this.width=o||this.defaultWidth,this.color=t||this.defaultColor,e.forEach((e=>{this.drawLine(e)})),this.end()}))}async playPath(e){if(console.log("playPath",e),!e.length)return Promise.resolve();this.isComplete=!0,await new Promise((t=>{let o=0,a=0;const l=e=>{this.drawLine(e),requestAnimationFrame(r)},r=()=>{if(this.isComplete)this.end();else{if(!this.isPlay)return requestAnimationFrame(r);if(a>=e[o].pos.length){if(this.end(),!(++o<e.length))return this.isComplete=!0,t(void 0);a=0,this.color=e[o].color||this.defaultColor,this.width=e[o].width||this.defaultWidth,setTimeout((()=>{l(e[o].pos[a++])}),240)}else l(e[o].pos[a++])}};setTimeout((()=>{this.isPlay=!0,this.isComplete=!1,this.color=e[0].color||this.defaultColor,this.width=e[0].width||this.defaultWidth,r()}),100)}))}}function N(e,{width:t,height:o}){const{clientX:a,clientY:l}=e.touches?e.touches[0]:e;return{x:a-.5*t,y:l-.5*o}}const S=()=>{};let T,D=!1;const M=({onDrawChange:e=S,onDrawEnd:t=S})=>{const o=u.exports.useRef(null);let a=u.exports.useRef(),{state:l,dispatch:r}=u.exports.useContext(b);u.exports.useEffect((()=>{o.current.width=innerWidth,o.current.height=innerHeight;const e=o.current.getContext("2d");e.translate(.5*innerWidth,.5*innerHeight),a.current=function(e){if(!e)throw new Error("请提供 ctx");return new k(e)}(e)}),[]),u.exports.useEffect((()=>{var e,t;null==(e=a.current)||e.setBackground(l.backgroundColor),null==(t=a.current)||t.drawPath(l.path)}),[l.backgroundColor]),u.exports.useEffect((()=>{a.current.color=l.color}),[l.color]),u.exports.useEffect((()=>{a.current.width=l.width}),[l.width]),u.exports.useEffect((()=>{var e,t,o,s;l.previewMode?l.path.length&&(null==(e=n())||e.then((()=>{null==r||r({type:"setPlay",payload:!1}),null==r||r({type:"setShowPreviewCover",payload:!0})}))):(null==(t=a.current)||t.clear(),null==(o=a.current)||o.setBackground(l.backgroundColor),null==(s=a.current)||s.drawPath(l.path))}),[l.previewMode,l.path]),u.exports.useEffect((()=>{var e;l.preview&&l.path.length&&(null==(e=n())||e.then((()=>{null==r||r({type:"setPreview",payload:!1})})))}),[l.preview]),u.exports.useEffect((()=>{var e;l.previewMode&&l.play&&l.path.length&&(a.current.isComplete?null==(e=n())||e.then((()=>{null==r||r({type:"setPlay",payload:!1}),null==r||r({type:"setShowPreviewCover",payload:!0})})):a.current.isPlay=!0)}),[l.play]);const n=()=>{var e,t,o;return null==(e=a.current)||e.clear(),null==(t=a.current)||t.setBackground(l.backgroundColor),null==(o=a.current)?void 0:o.playPath(l.path)},s=t=>{var r;if(l.previewMode||l.preview)return;D=!0;const n=N(t,o.current);T={width:l.width,color:l.color,pos:[n]},a.current.color=l.color,a.current.width=l.width,null==(r=a.current)||r.drawLine(n),e(n)},c=t=>{var l;if(D){const r=N(t,o.current);T.pos.push(r),null==(l=a.current)||l.drawLine(r),e(r)}},i=()=>{var e;if(D){D=!1;const o=[...l.path,T];null==r||r({type:"setPath",payload:o}),null==(e=a.current)||e.end(),t(o)}};return d.createElement(d.Fragment,null,d.createElement("canvas",{ref:o,onTouchStart:s,onTouchMove:c,onTouchEnd:i,onTouchCancel:i,onMouseDown:s,onMouseMove:c,onMouseUp:i,onClick:()=>{l.previewMode&&(a.current.isPlay=!1,null==r||r({type:"setPlay",payload:!1}),null==r||r({type:"setShowPreviewCover",payload:!0}))}}))},F=["#ffffff","#000000","#FF3333","#0066FF","#FFFF33","#33CC66"],O=[{value:2,width:4},{value:4,width:6},{value:6,width:8},{value:12,width:10},{value:20,width:12},{value:30,width:14}],W=()=>{const{state:e,dispatch:t}=u.exports.useContext(b);return e.previewMode?null:d.createElement(d.Fragment,null,d.createElement("ul",{className:"toolbar"},d.createElement("li",{className:"button",onClick:()=>{if(e.preview)return;const o=e.path.slice(0,e.path.length-1);null==t||t({type:"setPath",payload:o})}},d.createElement("i",{className:"iconfont icon-revoke"})),d.createElement("li",{className:"button",onClick:()=>{e.preview||null==t||t({type:"setPath",payload:[]})}},d.createElement("i",{className:"iconfont icon-clear"})),d.createElement("li",{className:"button",onClick:()=>{if(!e.preview)return e.path.length?void(null==t||t({type:"setPreview",payload:!0})):h.error("先随便画点什么吧~")}},d.createElement("i",{className:"iconfont icon-preview"})),d.createElement("li",{className:"button",onClick:()=>{var t;if(!e.path.length)return h.error("先随便画点什么吧~");!function(e,t=String(Date.now())){const o=document.createElement("a");o.download=t,o.href=e,o.click()}(null==(t=document.querySelector("canvas"))?void 0:t.toDataURL())}},d.createElement("i",{className:"iconfont icon-download"})),d.createElement("li",{className:"button",onClick:()=>{if(!e.path.length)return h.error("先随便画点什么吧~");const o=p(8);null==t||t({type:"setCode",payload:o}),null==t||t({type:"setSave",payload:!0}),null==t||t({type:"setShowPwdDialog",payload:!0})}},d.createElement("i",{className:"iconfont icon-share"}))),d.createElement("ul",{className:"color-bar",onClick:e=>{const o=e.target;o.checked&&(null==t||t({type:"setColor",payload:o.value}))}},F.map(((t,o)=>d.createElement("li",{className:"button",key:o},d.createElement("input",{type:"radio",name:"color",value:t,checked:e.color===t,readOnly:!0}),d.createElement("i",{className:"icon",style:{color:t}})))),d.createElement("div",{className:"line"}),d.createElement("li",{className:"button"},d.createElement("input",{type:"color",name:"color",value:e.color,onInput:e=>{const o=e.target;null==t||t({type:"setColor",payload:o.value})}}),d.createElement("i",{className:"icon",style:{color:e.color}})),d.createElement("div",{className:"line"}),d.createElement("li",{className:"button"},d.createElement("input",{type:"color",name:"color",value:e.backgroundColor,onInput:e=>{const o=e.target;null==t||t({type:"setBackgroundColor",payload:o.value})}}),d.createElement("i",{className:"icon",style:{color:e.backgroundColor}}))),d.createElement("ul",{className:"width-bar",onClick:e=>{const o=e.target;o.checked&&(null==t||t({type:"setWidth",payload:+o.value}))}},O.map((({value:t,width:o},a)=>d.createElement("li",{className:"button",key:a},d.createElement("input",{type:"radio",name:"width",value:t,checked:t===e.width,readOnly:!0}),d.createElement("i",{className:"icon",style:{width:`${o}px`,height:`${o}px`}}))))))},j=()=>{};let B;const R=({onConfirm:e=j,onCancel:t=j})=>{const{state:o,dispatch:a}=u.exports.useContext(b);let[l,r]=u.exports.useState(o.showPwdDialog),[n,s]=u.exports.useState({}),[c,i]=u.exports.useState("");u.exports.useEffect((()=>{l&&i(o.isSave?o.code:"")}),[l]),u.exports.useEffect((()=>{o.showPwdDialog?(clearTimeout(B),r(!0),s({opacity:"0",transform:"scale(1.2)"}),setTimeout((()=>{s({opacity:"1",transition:"all .4s"})}),50)):(s({opacity:"0",transform:"scale(1.2)",transition:"all .4s"}),B=setTimeout((()=>{i(""),r(!1)}),400))}),[o.showPwdDialog]);return l?d.createElement("div",{className:"tui-dialog my",style:n},d.createElement("div",{className:"cover mask"}),d.createElement("div",{className:"tui-dialog__body"},d.createElement("div",{className:"tui-dialog__hd"},"请输入口令："),d.createElement("div",{className:"tui-dialog__content"},d.createElement("input",{type:"text",name:"code",placeholder:"口令",value:c,onInput:e=>{i(e.target.value)},onFocus:e=>{e.target.select()}})),d.createElement("div",{className:"tui-dialog__ft"},d.createElement("a",{className:"btn",onClick:()=>{null==a||a({type:"setShowPwdDialog",payload:!1}),t()}},"取消"),d.createElement("a",{className:"btn",onClick:()=>{c?(null==a||a({type:"setShowPreviewCover",payload:!1}),null==a||a({type:"setShowPwdDialog",payload:!1}),e(c)):h.error("请输入一个口令")}},"确定")))):null};let _;const L=()=>{const{state:e,dispatch:t}=u.exports.useContext(b);let[o,a]=u.exports.useState(e.showPreviewCover),[l,r]=u.exports.useState("0");u.exports.useEffect((()=>{e.showPreviewCover?(clearTimeout(_),a(!0),setTimeout((()=>{r("1")}),50)):(r("0"),_=setTimeout((()=>{a(!1)}),400))}),[e.showPreviewCover]);return o?d.createElement("div",{className:"preview-cover",style:{opacity:l}},d.createElement("i",{className:"iconfont icon-play",onClick:()=>{null==t||t({type:"setPlay",payload:!0}),null==t||t({type:"setShowPreviewCover",payload:!1})}}),d.createElement("div",{className:"bottom"},d.createElement("a",{className:"btn",href:"?edit"},"我也要玩~"),d.createElement("a",{className:"btn",onClick:()=>{null==t||t({type:"setSave",payload:!1}),null==t||t({type:"setShowPwdDialog",payload:!0})}},"输入口令"))):null};m.interceptors.request.use((e=>(e.baseURL="https://ff827abe-e27d-48d4-a09a-81355a2ce85d.bspapp.com/draw/",e.headers["Content-Type"]="application/json",e))),m.interceptors.response.use((e=>{if(200===e.status)return e.data;throw new Error(e)}));const q=()=>{const[e,t]=u.exports.useReducer(P,x);u.exports.useEffect((()=>{e.previewMode&&o(e.code)}),[]);const o=e=>(e=>{const t=w.Toast.loading("");return m.get("path/get",{params:e}).then((({data:e})=>e)).catch((e=>{throw w.Toast.error("数据加载失败，请重试~"),new Error(e)})).finally(t)})({code:e}).then((e=>{if(!e.length)return void y({title:"提示",content:"链接已失效~",buttons:[{text:"去分享",onClick:async()=>{location.search="?edit"}}]});const{path:o,background:a="#ffffff",title:l,code:r}=e[0];var n;l&&(document.title=l),t({type:"setBackgroundColor",payload:a}),t({type:"setPath",payload:r?o:(n=o,n.map((e=>c(s({},e),{pos:e.pos.map((({x:e,y:t})=>({x:e-180,y:t-284})))}))))})}));return d.createElement(b.Provider,{value:{state:e,dispatch:t}},d.createElement(M,null),d.createElement(W,null),d.createElement(L,null),d.createElement(R,{onConfirm:t=>{e.isSave?(e=>{const t=w.Toast.loading("");return m.post("path/add",c(s({},e),{createTime:Date.now()})).catch((e=>{throw w.Toast.error("网络开小差了，请重试~"),new Error(e)})).finally(t)})({code:t=t||e.code,path:e.path,background:e.backgroundColor}).then((()=>{const e=location.origin+location.pathname+"?code="+t;console.log("share url",e),v(e),y({title:"提示",content:"链接已复制，赶紧去微信粘贴分享给小伙伴吧~\n"+e,buttons:[{text:"确定",onClick:async()=>{v(e)}}]})})):t&&o(t)}}))};f.exports.render(d.createElement(q,null),document.querySelector("#app"));
