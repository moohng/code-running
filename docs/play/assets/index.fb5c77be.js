var t=Object.defineProperty,e=Object.defineProperties,o=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,c=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,s=(t,e)=>{for(var o in e||(e={}))i.call(e,o)&&c(t,o,e[o]);if(r)for(var o of r(e))n.call(e,o)&&c(t,o,e[o]);return t},a=(t,r)=>e(t,o(r));axios.interceptors.request.use((t=>(t.baseURL="https://ff827abe-e27d-48d4-a09a-81355a2ce85d.bspapp.com/draw/",t.headers["Content-Type"]="application/json",t))),axios.interceptors.response.use((t=>{if(200===t.status)return t.data;throw new Error(t)}));const l=document.querySelector("#canvas");l.width=innerWidth,l.height=innerHeight;let d="#000000",u="#ffffff",h=6;const f=l.getContext("2d");f.translate(.5*l.width,.5*l.height);const p=new class{constructor(t,e,o=6){this.ctx=t,this.defaultWidth=6,this.defaultColor="#000000",this.restarting=!0,this.isPlay=!1,this.isComplete=!1,this.setBackground(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.color=e||this.defaultColor,this.width=o}set color(t){this.ctx.strokeStyle=t||this.defaultColor}get color(){return this.ctx.strokeStyle}set width(t){this.ctx.lineWidth=t||this.defaultWidth}get width(){return this.ctx.lineWidth}get background(){return this.ctx.fillStyle}drawLine(t,e){return this.restarting&&(this.restarting=!1,this.ctx.moveTo(t,e),this.ctx.beginPath()),this.ctx.lineTo(t,e),this.ctx.stroke(),this}end(){return this.restarting=!0,this.ctx.closePath(),this}setBackground(t){this.ctx.fillStyle=t||"#ffffff";const{width:e,height:o}=this.ctx.canvas;this.ctx.fillRect(-e/2,-o/2,e,o)}clear(){const{width:t,height:e}=this.ctx.canvas;this.ctx.clearRect(-t/2,-e/2,t,e)}drawPath(t){console.log("drawPath",t),t.length&&t.forEach((({pos:t,color:e,width:o})=>{this.width=o||this.defaultWidth,this.color=e||this.defaultColor,t.forEach((({x:t,y:e})=>{this.drawLine(t,e)})),this.end()}))}async playPath(t){if(console.log("playPath",t),!t.length)return Promise.resolve();this.isComplete=!0,await new Promise((e=>{let o=0,r=0;const i=({x:t,y:e})=>{this.drawLine(t,e),requestAnimationFrame(n)},n=()=>{if(this.isComplete)this.end();else{if(!this.isPlay)return requestAnimationFrame(n);if(r>=t[o].pos.length){if(this.end(),!(++o<t.length))return this.isComplete=!0,e(void 0);r=0,this.color=t[o].color||this.defaultColor,this.width=t[o].width||this.defaultWidth,setTimeout((()=>{i(t[o].pos[r++])}),240)}else i(t[o].pos[r++])}};setTimeout((()=>{this.isPlay=!0,this.isComplete=!1,this.color=t[0].color||this.defaultColor,this.width=t[0].width||this.defaultWidth,n()}),100)}))}}(f,d,h);let m,g=[],y=!1;const{code:w="秦丹",edit:v}=dan.querystring(location.search);console.log("口令",w,v);let k=!!w&&void 0===v;const S="ontouchstart"in document.documentElement;if(k)document.querySelector(".toolbar").style.opacity="0",document.querySelector(".color-bar").style.opacity="0",document.querySelector(".width-bar").style.opacity="0",x(w),document.querySelector(".preview-cover").addEventListener("click",(function(t){if(t.target!==t.currentTarget)return;if(p.isComplete)return this.classList.remove("mask"),p.clear(),p.setBackground(u),void p.playPath(g).then((()=>{document.querySelector(".preview-cover").classList.add("mask")}));p.isPlay=!p.isPlay,p.isPlay?this.classList.remove("mask"):this.classList.add("mask")}),!1),document.querySelector("#pwdConfirm").addEventListener("click",(function(){const t=document.querySelector("#code").value;if(!t)return tui.Toast.error("请输入一个口令");location.hash="",document.querySelector(".preview-cover").classList.remove("mask"),x(t)}),!1);else{const t=S?"touchstart":"mousedown",e=S?"touchmove":"mousemove",o=S?"touchend":"mouseup",r=S?"touchcancel":"mouseleave";l.addEventListener(t,(function(t){if(k)return;y=!0;let{clientX:e,clientY:o}=S?t.touches[0]:t;e-=.5*l.width,o-=.5*l.height;const r={x:e,y:o};p.color=d,p.width=h,m={width:p.width,color:p.color,pos:[r]},p.drawLine(e,o)}),!1),l.addEventListener(e,(function(t){if(y){let{clientX:e,clientY:o}=S?t.touches[0]:t;e-=.5*l.width,o-=.5*l.height,m.pos.push({x:e,y:o}),p.drawLine(e,o)}}),!1),l.addEventListener(o,b,!1),l.addEventListener(r,b,!1),document.querySelector(".preview-cover").style.display="none"}function x(t){return(t=>{const e=tui.Toast.loading("");return axios.get("path/get",{params:t}).then((({data:t})=>t)).catch((t=>{throw tui.Toast.error("数据加载失败，请重试~"),new Error(t)})).finally(e)})({code:t}).then((t=>{if(!t.length)return tui.Dialog({title:"提示",content:"链接已失效~",buttons:[{text:"去分享",onClick:async()=>location.search="?edit"}]});const{path:e,background:o="#ffffff",title:r,code:i}=t[0];return r&&(document.title=r),g=i?e:e.map((t=>a(s({},t),{pos:t.pos.map((({x:t,y:e})=>({x:t-180,y:e-284})))}))),u=o,p.clear(),p.setBackground(u),p.playPath(g).then((()=>{document.querySelector(".preview-cover").classList.add("mask")}))}))}function b(){y&&(y=!1,g.push(m),m=null,p.end())}document.querySelector("#share").addEventListener("click",(function(t){if(!g.length)return tui.Toast.error("先随便画点什么吧~");const e=dan.random(8);(t=>{const e=tui.Toast.loading("");return axios.post("path/add",a(s({},t),{createTime:Date.now()})).catch((t=>{throw tui.Toast.error("网络开小差了，请重试~"),new Error(t)})).finally(e)})({code:e,path:g,background:p.background}).then((()=>{const t=location.origin+location.pathname+"?code="+e;console.log("share url",t),dan.copy(t),tui.Dialog({title:"提示",content:"链接已复制，赶紧去微信粘贴分享给小伙伴吧~\n"+t,buttons:[{text:"确定",onClick:async()=>dan.copy(t)}]})}))}),!1),document.querySelector("#clear").addEventListener("click",(function(t){k||(g=[],p.clear(),p.setBackground(),u=p.background)}),!1),document.querySelector("#revoke").addEventListener("click",(function(t){k||(g.pop(),p.clear(),p.setBackground(u),p.drawPath(g))}),!1),document.querySelector("#preview").addEventListener("click",(function(t){if(!k){if(!g.length)return tui.Toast.error("先随便画点什么吧~");k=!0,p.clear(),p.setBackground(u),p.playPath(g).then((()=>{k=!1,document.querySelector(".preview-cover").classList.add("mask")}))}}),!1),document.querySelector("#download").addEventListener("click",(function(t){if(!g.length)return tui.Toast.error("先随便画点什么吧~");!function(t,e=String(Date.now())){const o=document.createElement("a");o.download=e,o.href=t,o.click()}(l.toDataURL())}),!1),document.querySelector(".color-bar").addEventListener("click",(function(t){t.target.checked&&(d=t.target.value),console.log("color select",t.target.value)}),!1),document.querySelector(".width-bar").addEventListener("click",(function(t){t.target.checked&&(h=+t.target.value),console.log("width select",t.target.value)}),!1),document.querySelector("#colorSelect").addEventListener("click",(t=>{t.stopPropagation()}),!1),document.querySelector("#backgroundSelect").addEventListener("click",(t=>{t.stopPropagation()}),!1),document.querySelector("#colorSelect").addEventListener("input",(function(t){d=t.target.value,this.nextElementSibling.style.color=d}),!1),document.querySelector("#backgroundSelect").addEventListener("input",(function(t){u=t.target.value,this.nextElementSibling.style.color=u,p.clear(),p.setBackground(u),p.drawPath(g)}),!1);
