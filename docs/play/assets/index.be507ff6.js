var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,l=(t,o,r)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[o]=r,s=(e,t)=>{for(var o in t||(t={}))a.call(t,o)&&l(e,o,t[o]);if(r)for(var o of r(t))n.call(t,o)&&l(e,o,t[o]);return e},c=(e,r)=>t(e,o(r));import{q as i,D as u,R as d,T as p,r as h,a as m,b as v,c as w,d as y,e as f}from"./vendor.effd306c.js";const E={setPath:(e,t)=>c(s({},e),{path:t}),setPlay:(e,t)=>c(s({},e),{play:t}),setShowPreviewCover:(e,t)=>c(s({},e),{showPreviewCover:t}),setColor:(e,t)=>c(s({},e),{color:t}),setBackgroundColor:(e,t)=>c(s({},e),{backgroundColor:t}),setWidth:(e,t)=>c(s({},e),{width:t}),setShowPwdDialog:(e,t)=>c(s({},e),{showPwdDialog:t}),setPreviewMode:(e,t)=>c(s({},e),{previewMode:t}),setPreview:(e,t)=>c(s({},e),{preview:t}),setSave:(e,t)=>c(s({},e),{isSave:t}),setCode:(e,t)=>c(s({},e),{code:t})},{code:g="秦丹",edit:x}=i(location.search);console.log("口令",g,x);const C={path:[],color:"#000000",backgroundColor:"#ffffff",width:4,play:!1,code:g,previewMode:!!g&&void 0===x,showPreviewCover:!1,showPwdDialog:!1,isSave:!1,preview:!1},b=(e,t)=>{var o;return null==(o=E[t.type])?void 0:o.call(E,e,t.payload)},P=u.exports.createContext({state:C});class k{constructor(e,t,o=6){this.ctx=e,this.defaultWidth=6,this.defaultColor="#000000",this.row=0,this.column=0,this.stop=!1,this.path=[],this.isComplete=!1,this.setBackground(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.color=t||this.defaultColor,this.width=o}set color(e){this.ctx.strokeStyle=e||this.defaultColor}get color(){return this.ctx.strokeStyle}set width(e){this.ctx.lineWidth=e||this.defaultWidth}get width(){return this.ctx.lineWidth}get background(){return this.ctx.fillStyle}drawLine({x:e,y:t}){this.ctx.lineTo(e,t),this.ctx.stroke()}start({x:e,y:t},o=this.defaultColor,r=this.defaultWidth){this.ctx.beginPath(),this.ctx.moveTo(e,t),this.color=o,this.width=r}setBackground(e){this.ctx.fillStyle=e||"#ffffff";const{width:t,height:o}=this.ctx.canvas;this.ctx.fillRect(-t/2,-o/2,t,o)}clear(){const{width:e,height:t}=this.ctx.canvas;this.ctx.clearRect(-e/2,-t/2,e,t)}drawPath(e){console.log("绘制轨迹",e),e.length&&e.forEach((({pos:e,color:t,width:o})=>{this.start(e[0],t,o),e.forEach((e=>{this.drawLine(e)}))}))}playPath(e,t){if(console.log("播放轨迹",e),!e.length)return Promise.resolve();this.path=e,this.row=0,this.column=0,this.stop=!1,this.isComplete=!1;const{pos:o,color:r,width:a}=e[0];this.start(o[0],r,a),this.run(t),t&&(this.completed=t)}completed(){}run(e=this.completed){if(!this.stop)if(this.column<this.path[this.row].pos.length)this.drawLine(this.path[this.row].pos[this.column++]),requestAnimationFrame((()=>this.run()));else if(++this.row<this.path.length){this.column=0;const{pos:e,color:t,width:o}=this.path[this.row];this.start(e[0],t,o),setTimeout((()=>{requestAnimationFrame((()=>this.run()))}),240)}else this.isComplete=!0,e()}pause(){this.stop=!0}play(e){this.stop=!1,this.run(e)}}function N({x:e,y:t},{width:o,height:r}){return{x:e-.5*o,y:t-.5*r}}let S,L=!1;function T(e){if(e instanceof TouchEvent){const{clientX:t,clientY:o}=e.touches[0];return{x:t,y:o}}const{clientX:t,clientY:o}=e;return{x:t,y:o}}const D=()=>{const e=u.exports.useRef(null);let t=u.exports.useRef(),{state:o,dispatch:r}=u.exports.useContext(P);u.exports.useLayoutEffect((()=>{e.current.width=innerWidth,e.current.height=innerHeight;const o=e.current.getContext("2d");o.translate(.5*innerWidth,.5*innerHeight),t.current=function(e){if(!e)throw new Error("请提供 ctx");return new k(e)}(o)}),[]),u.exports.useLayoutEffect((()=>{var e,r;null==(e=t.current)||e.setBackground(o.backgroundColor),null==(r=t.current)||r.drawPath(o.path)}),[o.backgroundColor]),u.exports.useLayoutEffect((()=>{t.current.color=o.color}),[o.color]),u.exports.useLayoutEffect((()=>{t.current.width=o.width}),[o.width]),u.exports.useLayoutEffect((()=>{var e,n,l;o.previewMode?o.path.length&&a((()=>{null==r||r({type:"setPlay",payload:!1}),null==r||r({type:"setShowPreviewCover",payload:!0})})):(null==(e=t.current)||e.clear(),null==(n=t.current)||n.setBackground(o.backgroundColor),null==(l=t.current)||l.drawPath(o.path))}),[o.previewMode,o.path]),u.exports.useLayoutEffect((()=>{o.preview&&o.path.length&&a((()=>{null==r||r({type:"setPreview",payload:!1})}))}),[o.preview]),u.exports.useLayoutEffect((()=>{var e,n;o.previewMode&&o.play&&o.path.length&&((null==(e=t.current)?void 0:e.isComplete)?a((()=>{null==r||r({type:"setPlay",payload:!1}),null==r||r({type:"setShowPreviewCover",payload:!0})})):null==(n=t.current)||n.play())}),[o.play]);const a=e=>{var r,a,n;return null==(r=t.current)||r.clear(),null==(a=t.current)||a.setBackground(o.backgroundColor),null==(n=t.current)?void 0:n.playPath(o.path,e)},{dot:n,status:l}=function(e,t=!1){const[o,r]=u.exports.useState({x:0,y:0}),[a,n]=u.exports.useState("init");return u.exports.useLayoutEffect((()=>{const o=o=>{if(!t)return;L=!0,n("down");const a=N(T(o),e.current);r(a)};return e.current.addEventListener("touchstart",o,!1),e.current.addEventListener("mousedown",o,!1),()=>{e.current.removeEventListener("touchstart",o,!1),e.current.removeEventListener("mousedown",o,!1)}}),[]),u.exports.useLayoutEffect((()=>{const o=o=>{if(!t||!L)return;n("move");const a=N(T(o),e.current);r(a)};return e.current.addEventListener("touchmove",o,!1),e.current.addEventListener("mousemove",o,!1),()=>{e.current.removeEventListener("touchmove",o,!1),e.current.removeEventListener("mousemove",o,!1)}}),[]),u.exports.useLayoutEffect((()=>{const o=()=>{t&&L&&(L=!1,n("up"))};return e.current.addEventListener("touchend",o,!1),e.current.addEventListener("mouseup",o,!1),()=>{e.current.removeEventListener("touchend",o,!1),e.current.removeEventListener("mouseup",o,!1)}}),[]),{dot:o,status:a}}(e,!o.previewMode&&!o.preview);u.exports.useLayoutEffect((()=>{var e,r,a;"down"===l?(null==(e=t.current)||e.start(n,o.color,o.width),null==(r=t.current)||r.drawLine(n),S={width:o.width,color:o.color,pos:[n]}):"move"===l&&(null==(a=t.current)||a.drawLine(n),S.pos.push(n))}),[n]),u.exports.useLayoutEffect((()=>{if("up"===l){const e=[...o.path,S];null==r||r({type:"setPath",payload:e})}}),[l]);return d.createElement("canvas",{ref:e,onClick:()=>{var e;o.previewMode&&(null==(e=t.current)||e.pause(),null==r||r({type:"setPlay",payload:!1}),null==r||r({type:"setShowPreviewCover",payload:!0}))}})},F=["#ffffff","#000000","#FF3333","#0066FF","#FFFF33","#33CC66"],O=[{value:2,width:4},{value:4,width:6},{value:6,width:8},{value:12,width:10},{value:20,width:12},{value:30,width:14}],M=()=>{const{state:e,dispatch:t}=u.exports.useContext(P);return e.previewMode?null:d.createElement(d.Fragment,null,d.createElement("ul",{className:"toolbar"},d.createElement("li",{className:"button",onClick:()=>{if(e.preview)return;const o=e.path.slice(0,e.path.length-1);null==t||t({type:"setPath",payload:o})}},d.createElement("i",{className:"iconfont icon-revoke"})),d.createElement("li",{className:"button",onClick:()=>{e.preview||null==t||t({type:"setPath",payload:[]})}},d.createElement("i",{className:"iconfont icon-clear"})),d.createElement("li",{className:"button",onClick:()=>{if(!e.preview)return e.path.length?void(null==t||t({type:"setPreview",payload:!0})):p.error("先随便画点什么吧~")}},d.createElement("i",{className:"iconfont icon-preview"})),d.createElement("li",{className:"button",onClick:()=>{var t;if(!e.path.length)return p.error("先随便画点什么吧~");!function(e,t=String(Date.now())){const o=document.createElement("a");o.download=t,o.href=e,o.click()}(null==(t=document.querySelector("canvas"))?void 0:t.toDataURL())}},d.createElement("i",{className:"iconfont icon-download"})),d.createElement("li",{className:"button",onClick:()=>{if(!e.path.length)return p.error("先随便画点什么吧~");const o=h(8);null==t||t({type:"setCode",payload:o}),null==t||t({type:"setSave",payload:!0}),null==t||t({type:"setShowPwdDialog",payload:!0})}},d.createElement("i",{className:"iconfont icon-share"}))),d.createElement("ul",{className:"color-bar",onClick:e=>{const o=e.target;o.checked&&(null==t||t({type:"setColor",payload:o.value}))}},F.map(((t,o)=>d.createElement("li",{className:"button",key:o},d.createElement("input",{type:"radio",name:"color",value:t,checked:e.color===t,readOnly:!0}),d.createElement("i",{className:"icon",style:{color:t}})))),d.createElement("div",{className:"line"}),d.createElement("li",{className:"button"},d.createElement("input",{type:"color",name:"color",value:e.color,onInput:e=>{const o=e.target;null==t||t({type:"setColor",payload:o.value})}}),d.createElement("i",{className:"icon",style:{color:e.color}})),d.createElement("div",{className:"line"}),d.createElement("li",{className:"button"},d.createElement("input",{type:"color",name:"color",value:e.backgroundColor,onInput:e=>{const o=e.target;null==t||t({type:"setBackgroundColor",payload:o.value})}}),d.createElement("i",{className:"icon",style:{color:e.backgroundColor}}))),d.createElement("ul",{className:"width-bar",onClick:e=>{const o=e.target;o.checked&&(null==t||t({type:"setWidth",payload:+o.value}))}},O.map((({value:t,width:o},r)=>d.createElement("li",{className:"button",key:r},d.createElement("input",{type:"radio",name:"width",value:t,checked:t===e.width,readOnly:!0}),d.createElement("i",{className:"icon",style:{width:`${o}px`,height:`${o}px`,color:e.color}}))))))},W=()=>{};let j;const B=({onConfirm:e=W,onCancel:t=W})=>{const{state:o,dispatch:r}=u.exports.useContext(P);let[a,n]=u.exports.useState(o.showPwdDialog),[l,s]=u.exports.useState({}),[c,i]=u.exports.useState("");u.exports.useEffect((()=>{a&&i(o.isSave?o.code:"")}),[a]),u.exports.useEffect((()=>{o.showPwdDialog?(clearTimeout(j),n(!0),s({opacity:"0",transform:"scale(1.2)"}),setTimeout((()=>{s({opacity:"1",transition:"all .4s"})}),50)):(s({opacity:"0",transform:"scale(1.2)",transition:"all .4s"}),j=setTimeout((()=>{i(""),n(!1)}),400))}),[o.showPwdDialog]);return a?d.createElement("div",{className:"tui-dialog my",style:l},d.createElement("div",{className:"cover mask"}),d.createElement("div",{className:"tui-dialog__body"},d.createElement("div",{className:"tui-dialog__hd"},"请输入口令："),d.createElement("div",{className:"tui-dialog__content"},d.createElement("input",{type:"text",name:"code",placeholder:"口令",value:c,onInput:e=>{i(e.target.value)},onFocus:e=>{e.target.select()}})),d.createElement("div",{className:"tui-dialog__ft"},d.createElement("a",{className:"btn",onClick:()=>{null==r||r({type:"setShowPwdDialog",payload:!1}),t()}},"取消"),d.createElement("a",{className:"btn",onClick:()=>{c?(null==r||r({type:"setShowPreviewCover",payload:!1}),null==r||r({type:"setShowPwdDialog",payload:!1}),e(c)):p.error("请输入一个口令")}},"确定")))):null};let R;const _=()=>{const{state:e,dispatch:t}=u.exports.useContext(P);let[o,r]=u.exports.useState(e.showPreviewCover),[a,n]=u.exports.useState("0");u.exports.useEffect((()=>{e.showPreviewCover?(clearTimeout(R),r(!0),setTimeout((()=>{n("1")}),50)):(n("0"),R=setTimeout((()=>{r(!1)}),400))}),[e.showPreviewCover]);return o?d.createElement("div",{className:"preview-cover",style:{opacity:a}},d.createElement("i",{className:"iconfont icon-play",onClick:()=>{null==t||t({type:"setPlay",payload:!0}),null==t||t({type:"setShowPreviewCover",payload:!1})}}),d.createElement("div",{className:"bottom"},d.createElement("a",{className:"btn",href:"?edit"},"我也要玩~"),d.createElement("a",{className:"btn",onClick:()=>{null==t||t({type:"setSave",payload:!1}),null==t||t({type:"setShowPwdDialog",payload:!0})}},"输入口令"))):null};m.interceptors.request.use((e=>(e.baseURL="https://ff827abe-e27d-48d4-a09a-81355a2ce85d.bspapp.com/draw/",e.headers["Content-Type"]="application/json",e))),m.interceptors.response.use((e=>{if(200===e.status)return e.data;throw new Error(e)}));const q=()=>{const[e,t]=u.exports.useReducer(b,C);u.exports.useEffect((()=>{e.previewMode&&o(e.code)}),[]);const o=async e=>{const o=await(e=>{const t=v.Toast.loading("");return m.get("path/get",{params:e}).then((({data:e})=>e)).catch((e=>{throw v.Toast.error("数据加载失败，请重试~"),new Error(e)})).finally(t)})({code:e});if(!o.length)return void w({title:"提示",content:"链接已失效~",buttons:[{text:"去分享",onClick:async()=>{location.search="?edit"}}]});const{path:r,background:a="#ffffff",title:n,code:l}=o[0];var i;n&&(document.title=n),t({type:"setBackgroundColor",payload:a}),t({type:"setPath",payload:l?r:(i=r,i.map((e=>c(s({},e),{pos:e.pos.map((({x:e,y:t})=>({x:e-180,y:t-284})))}))))})};return d.createElement(P.Provider,{value:{state:e,dispatch:t}},d.createElement(D,null),d.createElement(M,null),d.createElement(_,null),d.createElement(B,{onConfirm:t=>{e.isSave?(e=>{const t=v.Toast.loading("");return m.post("path/add",c(s({},e),{createTime:Date.now()})).catch((e=>{throw v.Toast.error("网络开小差了，请重试~"),new Error(e)})).finally(t)})({code:t=t||e.code,path:e.path,background:e.backgroundColor}).then((()=>{const e=location.origin+location.pathname+"?code="+t;console.log("share url",e),y(e),w({title:"提示",content:"链接已复制，赶紧去微信粘贴分享给小伙伴吧~\n"+e,buttons:[{text:"确定",onClick:async()=>{y(e)}}]})})):t&&o(t)}}))};f.exports.render(d.createElement(q,null),document.querySelector("#app"));
