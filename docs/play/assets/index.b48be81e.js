var t=Object.defineProperty,e=Object.defineProperties,o=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,c=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r;axios.interceptors.request.use((t=>(t.baseURL="https://ff827abe-e27d-48d4-a09a-81355a2ce85d.bspapp.com/draw/",t.headers["Content-Type"]="application/json",t))),axios.interceptors.response.use((t=>{if(200===t.status)return t.data;throw new Error(t)}));const s=t=>{const s=tui.Toast.loading("");return axios.post("path/add",(a=((t,e)=>{for(var o in e||(e={}))n.call(e,o)&&c(t,o,e[o]);if(r)for(var o of r(e))i.call(e,o)&&c(t,o,e[o]);return t})({},t),l={createTime:Date.now()},e(a,o(l)))).catch((t=>{throw tui.Toast.error("网络开小差了，请重试~"),new Error(t)})).finally(s);var a,l};const a=document.querySelector("#canvas");a.width=innerWidth,a.height=innerHeight;let l="#000000",d="#ffffff",u=6;const h=a.getContext("2d"),p=new class{constructor(t,e="#000000",o=6){this.ctx=t,this.isPlay=!1,this.isComplete=!1,this.setBackground(),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.color=e,this.width=o}set color(t){this.ctx.strokeStyle=t||"#000000"}get color(){return this.ctx.strokeStyle}set width(t){this.ctx.lineWidth=t||6}get width(){return this.ctx.lineWidth}get background(){return this.ctx.fillStyle}drawLine(t,e){return this.restarting&&(this.restarting=!1,this.ctx.moveTo(t,e),this.ctx.beginPath()),this.ctx.lineTo(t,e),this.ctx.stroke(),this}end(){return this.restarting=!0,this.ctx.closePath(),this}setBackground(t){this.ctx.fillStyle=t||"#ffffff";const{width:e,height:o}=this.ctx.canvas;this.ctx.fillRect(0,0,e,o)}clear(){const{width:t,height:e}=this.ctx.canvas;this.ctx.clearRect(0,0,t,e)}drawPath(t){console.log("drawPath",t),t.length&&t.forEach((({pos:t,color:e,width:o})=>{this.width=o,this.color=e,t.forEach((({x:t,y:e})=>{this.drawLine(t,e)})),this.end()}))}async playPath(t){if(console.log("playPath",t),!t.length)return Promise.resolve();this.isPlay=!0,this.isComplete=!1,await new Promise((e=>{let o=0,r=0;const n=({x:t,y:e})=>{this.drawLine(t,e),requestAnimationFrame(i)},i=()=>{if(!this.isPlay)return requestAnimationFrame(i);if(r>=t[o].pos.length){if(this.end(),!(++o<t.length))return this.isComplete=!0,e(void 0);r=0,this.color=t[o].color,this.width=t[o].width,setTimeout((()=>{n(t[o].pos[r++])}),240)}else n(t[o].pos[r++])};this.color=t[0].color,this.width=t[0].width,requestAnimationFrame(i)}))}}(h,l,u,d);let y=[],g={},m=!1;const{password:f="秦丹",edit:w}=dan.querystring(location.search);console.log("口令",f,w);let v=!!f&&void 0===w;const k="ontouchstart"in document.documentElement;if(v)document.querySelector(".toolbar").style.opacity=0,document.querySelector(".color-bar").style.opacity=0,document.querySelector(".width-bar").style.opacity=0,(t=>{const e=tui.Toast.loading("");return axios.get("path/get",{params:t}).then((({data:t})=>t)).catch((t=>{throw tui.Toast.error("数据加载失败，请重试~"),new Error(t)})).finally(e)})({password:f}).then((t=>{if(!t.length)return tui.Dialog({title:"提示",content:"链接已失效~",buttons:[{text:"去分享",onClick:async()=>location.search="?edit"}]});const{path:e,background:o,title:r}=t[0];return r&&(document.title=r),y=e,d=o,p.clear(),p.setBackground(o),p.playPath(e).then((()=>{document.querySelector("#previewCover").classList.add("mask")}))})),document.querySelector("#previewCover").addEventListener("click",(function(t){if(p.isComplete)return this.classList.remove("mask"),p.clear(),p.setBackground(d),p.playPath(y).then((()=>{document.querySelector("#previewCover").classList.add("mask")}));p.isPlay=!p.isPlay,p.isPlay?this.classList.remove("mask"):this.classList.add("mask")}),!1);else{const t=k?"touchstart":"mousedown",e=k?"touchmove":"mousemove",o=k?"touchend":"mouseup",r=k?"touchcancel":"mouseleave";a.addEventListener(t,(function(t){if(v)return;m=!0;const{clientX:e,clientY:o}=k?t.touches[0]:t,r={x:e,y:o};p.color=l,p.width=u,g={width:p.width,color:p.color,pos:[r]},p.drawLine(e,o)}),!1),a.addEventListener(e,(function(t){if(m){const{clientX:e,clientY:o}=k?t.touches[0]:t;g.pos.push({x:e,y:o}),p.drawLine(e,o)}}),!1),a.addEventListener(o,S,!1),a.addEventListener(r,S,!1),document.querySelector("#previewCover").style.display="none"}function S(){m&&(m=!1,y.push(g),g={},p.end())}document.querySelector("#share").addEventListener("click",(function(t){if(!y.length)return tui.Toast.error("先随便画点什么吧~");const e=dan.random(8);s({password:e,path:y,background:p.background}).then((()=>{const t=location.origin+location.pathname+"?password="+e;console.log("share url",t),dan.copy(t),tui.Dialog({title:"提示",content:"链接已复制，赶紧去微信粘贴分享给小伙伴吧~\n"+t,buttons:[{text:"确定",onClick:async()=>dan.copy(t)}]})}))}),!1),document.querySelector("#clear").addEventListener("click",(function(t){v||(y=[],p.clear(),p.setBackground(),d=p.background)}),!1),document.querySelector("#revoke").addEventListener("click",(function(t){v||(y.pop(),p.clear(),p.setBackground(d),p.drawPath(y))}),!1),document.querySelector("#preview").addEventListener("click",(function(t){if(!v){if(!y.length)return tui.Toast.error("先随便画点什么吧~");v=!0,p.clear(),p.setBackground(d),p.playPath(y).then((()=>{v=!1,document.querySelector("#previewCover").classList.add("mask")}))}}),!1),document.querySelector("#download").addEventListener("click",(function(t){if(!y.length)return tui.Toast.error("先随便画点什么吧~");!function(t,e=String(Date.now())){const o=document.createElement("a");o.download=e,o.href=t,o.click()}(a.toDataURL())}),!1),document.querySelector(".color-bar").addEventListener("click",(function(t){t.target.checked&&(l=t.target.value),console.log("color select",t.target.value)}),!1),document.querySelector(".width-bar").addEventListener("click",(function(t){t.target.checked&&(u=t.target.value),console.log("width select",t.target.value)}),!1),document.querySelector("#colorSelect").addEventListener("click",(t=>{t.stopPropagation()}),!1),document.querySelector("#backgroundSelect").addEventListener("click",(t=>{t.stopPropagation()}),!1),document.querySelector("#colorSelect").addEventListener("input",(function(t){l=t.target.value,this.nextElementSibling.style.color=l}),!1),document.querySelector("#backgroundSelect").addEventListener("input",(function(t){d=t.target.value,this.nextElementSibling.style.color=d,p.clear(),p.setBackground(d),p.drawPath(y)}),!1);
