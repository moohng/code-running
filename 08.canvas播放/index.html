<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>画个啥呀送给ta</title>
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_2748127_1ywubg7ty46.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@moohng/tui@1.2.0/dist/tui.min.css">
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@moohng/tui@1.2.0/dist/tui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@moohng/dan@2.1.0/dist/dan.min.js"></script>
</head>
<body>
  <canvas id="canvas"></canvas>

  <!-- 操作区域 -->
  <ul class="toolbar">
    <li id="revoke" class="button"><i class="iconfont icon-revoke"></i></li>
    <li id="clear" class="button"><i class="iconfont icon-clear"></i></li>
    <li id="preview" class="button"><i class="iconfont icon-preview"></i></li>
    <li id="download" class="button"><i class="iconfont icon-download"></i></li>
    <li id="share" class="button"><i class="iconfont icon-share"></i></li>
  </ul>

  <!-- 颜色选择 -->
  <ul class="color-bar">
    <li class="button">
      <input type="radio" name="color" value="#ffffff" />
      <i class="icon" style="color: #ffffff"></i>
    </li>
    <li class="button">
      <input type="radio" name="color" value="#000000" checked />
      <i class="icon" style="color: #000000"></i>
    </li>
    <li class="button">
      <input type="radio" name="color" value="#FF3333" />
      <i class="icon" style="color: #FF3333"></i>
    </li>
    <li class="button">
      <input type="radio" name="color" value="#0066FF" />
      <i class="icon" style="color: #0066FF"></i>
    </li>
    <li class="button">
      <input type="radio" name="color" value="#FFFF33" />
      <i class="icon" style="color: #FFFF33"></i>
    </li>
    <li class="button">
      <input type="radio" name="color" value="#33CC66" />
      <i class="icon" style="color: #33CC66"></i>
    </li>
    <div class="line"></div>
    <li class="button">
      <input id="colorSelect" type="color" name="color" value="#000000">
      <i class="icon" style="color: #000000"></i>
    </li>
    <div class="line"></div>
    <li class="button">
      <input id="backgroundSelect" type="color" name="color" value="#ffffff">
      <i class="icon" style="color: #ffffff"></i>
    </li>
  </ul>

  <!-- 画笔宽度 -->
  <ul class="width-bar">
    <li class="button">
      <input type="radio" name="width" value="2" />
      <i class="icon" style="width: 4px; height: 4px;"></i>
    </li>
    <li class="button">
      <input type="radio" name="width" value="4" />
      <i class="icon" style="width: 6px; height: 6px;"></i>
    </li>
    <li class="button">
      <input type="radio" name="width" value="6" checked />
      <i class="icon" style="width: 8px; height: 8px;"></i>
    </li>
    <li class="button">
      <input type="radio" name="width" value="12" />
      <i class="icon" style="width: 10px; height: 10px;"></i>
    </li>
    <li class="button">
      <input type="radio" name="width" value="20" />
      <i class="icon" style="width: 12px; height: 12px;"></i>
    </li>
    <li class="button">
      <input type="radio" name="width" value="30" />
      <i class="icon" style="width: 14px; height: 14px;"></i>
    </li>
  </ul>

  <!-- 播放控制 -->
  <div id="previewCover" class="preview-cover">
    <i class="iconfont icon-play"></i>
    <p><a href="?edit">我也要玩~</a></p>
  </div>

  <script type="module">
    import Paint from './Paint';
    import { fetchPath, addPath } from './api';
    import { download } from './util';

    /** 初始化 Canvas */
    const canvas = document.querySelector('#canvas');
    canvas.width = innerWidth;
    canvas.height = innerHeight;

    let paintColor = '#000000';
    let paintBackgroundColor = '#ffffff';
    let paintWidth = 6;

    const ctx = canvas.getContext('2d');
    const paint = new Paint(ctx, paintColor, paintWidth, paintBackgroundColor);

    // { path: [], background: '', backgroundColor: '', title: '' },
    let path = []; // 记录全部轨迹
    let currentLine = {}; // 记录每一笔 { pos: [{x, y}, {x, y}], width: 12, color: 'red' }
    let painting = false; // 正在绘图

    // 获取口令
    const { password = '秦丹', edit } = dan.querystring(location.search);
    console.log(password, edit);
    let isPreview = !!password && edit === undefined;

    const canTouch = 'ontouchstart' in document.documentElement;

    if (!isPreview) {
      /** 绘画事件监听 */
      const TOUCHSTART = canTouch ? 'touchstart' : 'mousedown';
      const TOUCHMOVE = canTouch ? 'touchmove' : 'mousemove';
      const TOUCHEND = canTouch ? 'touchend' : 'mouseup';
      const TOUCHCANCEL = canTouch ? 'touchcancel' : 'mouseleave';

      canvas.addEventListener(TOUCHSTART, onTouchStart, false);
      canvas.addEventListener(TOUCHMOVE, onTouchMove, false);
      canvas.addEventListener(TOUCHEND, onTouchEnd, false);
      canvas.addEventListener(TOUCHCANCEL, onTouchEnd, false);

      // document.querySelector('.toolbar').style.opacity = 1;
      // document.querySelector('.color-bar').style.opacity = 1;
      document.querySelector('#previewCover').style.display = 'none';
    } else {
      /** 播放 */
      fetchPath({ password }).then(({ path: _path, background, title }) => {
        if (title) {
          document.title = title;
        }
        path = _path;
        paintBackgroundColor = background;
        paint.background = background;
        return paint.playPath(_path).then(() => {
          document.querySelector('#previewCover').classList.add('mask');
        });
      });

      document.querySelector('#previewCover').addEventListener('click', onPlay, false);

      document.querySelector('.toolbar').style.opacity = 0;
      document.querySelector('.color-bar').style.opacity = 0;
      document.querySelector('.width-bar').style.opacity = 0;
    }

    function onTouchStart(e) {
      if (isPreview) return;
      painting = true;
      const { clientX: x, clientY: y } = canTouch ? e.touches[0] : e;
      const dot = { x, y };
      paint.color = paintColor;
      paint.width = paintWidth;
      currentLine = {
        width: paint.width,
        color: paint.color,
        pos: [dot],
      };
      paint.drawLine(x, y);
    }

    function onTouchMove(e) {
      if (painting) {
        const { clientX: x, clientY: y } = canTouch ? e.touches[0] : e;
        currentLine.pos.push({ x, y });
        paint.drawLine(x, y);
      }
    }

    function onTouchEnd() {
      painting = false;
      path.push(currentLine);
      currentLine = {};
      paint.end();
    }

    function onPlay(e) {
      if (paint.isComplete) {
        this.classList.remove('mask');
        return paint.playPath(path).then(() => {
          document.querySelector('#previewCover').classList.add('mask');
        });
      }
      paint.isPlay = !paint.isPlay;
      if (paint.isPlay) {
        this.classList.remove('mask');
      } else {
        this.classList.add('mask');
      }
    }

    /** 操作栏 */

    document.querySelector('#share').addEventListener('click', function(e) {
      if (!path.length) {
        return tui.Toast.error('先随便画点什么吧~');
      }
      // 生成随机口令
      const password = dan.random(8);
      addPath({ password, path, background: paint.background }).then(() => {
        const shareUrl = location.origin + location.pathname + '?password=' + password;
        console.log('share url', shareUrl);
        dan.copy(shareUrl);
        // tui.Toast.success('链接已复制，赶紧去微信粘贴分享给小伙伴吧~');
        tui.Dialog({
          title: '提示',
          content: '链接已复制，赶紧去微信粘贴分享给小伙伴吧~\n' + shareUrl,
          buttons: [{
            text: '确定',
            onClick: async () => {
              return dan.copy(shareUrl);
            },
          }],
        });
      });
    }, false);

    document.querySelector('#clear').addEventListener('click', function(e) {
      isPreview = false;
      path = [];
      paint.clear();
    }, false);

    document.querySelector('#revoke').addEventListener('click', function(e) {
      path.pop();
      paint.drawPath(path);
    }, false);

    document.querySelector('#preview').addEventListener('click', function(e) {
      if (!path.length) {
        return tui.Toast.error('先随便画点什么吧~');
      }
      isPreview = true;
      paint.background = paintBackgroundColor;
      paint.playPath(path).then(() => {
        isPreview = false;
        document.querySelector('#previewCover').classList.add('mask');
      });
    }, false);

    document.querySelector('#download').addEventListener('click', function(e) {
      if (!path.length) {
        return tui.Toast.error('先随便画点什么吧~');
      }
      download(canvas.toDataURL());
    }, false);

    /** 颜色选择 */

    document.querySelector('.color-bar').addEventListener('click', function(e) {
      if (e.target.checked) {
        paintColor = e.target.value;
      }
      console.log('e.target.value', e.target.value)
    }, false);

    document.querySelector('.width-bar').addEventListener('click', function(e) {
      if (e.target.checked) {
        paintWidth = e.target.value;
      }
      console.log('e.target.value', e.target.value)
    }, false);

    /** 自定义颜色 */

    document.querySelector('#colorSelect').addEventListener('click', (e) => {
      e.stopPropagation();
    }, false);
    document.querySelector('#backgroundSelect').addEventListener('click', (e) => {
      e.stopPropagation();
    }, false);
    document.querySelector('#colorSelect').addEventListener('input', function(e) {
      paintColor = e.target.value;
      this.nextElementSibling.style.color = paintColor;
    }, false);
    document.querySelector('#backgroundSelect').addEventListener('input', function(e) {
      paintBackgroundColor = e.target.value;
      this.nextElementSibling.style.color = paintBackgroundColor;
      paint.background = paintBackgroundColor;
      paint.drawPath(path);
    }, false);
  </script>
</body>
</html>
